<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Andamento Portafoglio</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: #0e0e0e;
      color: #f0f0f0;
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h1 {
      text-align: center;
      color: #fff;
      margin-bottom: 30px;
    }

    #grafico-container {
      background: rgba(255, 255, 255, 0.05);
      padding: 30px;
      border-radius: 18px;
      box-shadow: 0 0 25px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }

    /* assicuriamoci che il canvas abbia altezza */
    #grafico {
      width: 100% !important;
      height: 420px !important;
      display: block;
    }
  </style>
</head>

<body>

  <h1>ðŸ“ˆ Andamento Portafoglio</h1>

  <div id="grafico-container">
   <canvas id="grafico"></canvas>
  </div>

<h2 style="margin-top: 35px; margin-bottom: 15px; text-align:center;">
  ðŸ“Š Riepilogo Mensile
</h2>

<table id="tabella-mensile" class="mensile-table">
  <thead>
    <tr>
      <th>Data</th>
      <th>Investito</th>
      <th>Valore</th>
      <th>Incremento</th>
      <th>Profitto</th>
      <th>% Profitto</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  
<script type="module">
  import { db } from "./firebase-config.js";
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  // prende il context 2d
  const ctx = document.getElementById("grafico").getContext("2d");
  let grafico = null;

  async function loadAndamento() {
    try {
      const snap = await getDocs(collection(db, "andamento"));

      // costruisco array di record usando doc.id come DATA
      const records = [];
      snap.forEach(doc => {
        const d = doc.data();
        records.push({ id: doc.id, ...d });
      });

      console.log("DEBUG: records raw", records);
      if (!records.length) {
        console.log("DEBUG: nessun record trovato in Firestore");
        return;
      }

      // ordina per id (es. "2025-01-03")
      records.sort((a, b) => {
        // converti id in Date per confrontare
        const da = new Date(a.id);
        const db_ = new Date(b.id);
        return da - db_;
      });

      // prepara dati per il grafico
      const labels = [];
      const valoriGiornaliero = [];
      const valoriInvestito = [];

      records.forEach((r) => {
        // usa r.id come data, i campi numerici da document
        if (r.id == null) return;
        // accetta 0 come valore (usa == null per controllare null/undefined)
        if (r.GIORNALIERO == null || r.INVESTITO == null) return;

        // r.id Ã¨ tipo "2025-01-03" -> estraggo gg/mm per asse X
        const parts = String(r.id).split("-");
        let label;
        if (parts.length >= 3) {
          label = `${parts[2].padStart(2,"0")}/${parts[1].padStart(2,"0")}`; // gg/mm
        } else {
          label = r.id;
        }

        labels.push(label);
        valoriGiornaliero.push(Number(r.GIORNALIERO));
        valoriInvestito.push(Number(r.INVESTITO));
      });

      console.log("DEBUG labels:", labels);
      console.log("DEBUG giornaliero:", valoriGiornaliero);
      console.log("DEBUG investito:", valoriInvestito);

      // se non ci sono dati validi, esci
      if (!labels.length || !valoriGiornaliero.length || !valoriInvestito.length) {
        console.log("DEBUG: Nessun dato valido per il grafico");
        return;
      }

      renderGrafico(labels, valoriGiornaliero, valoriInvestito);

    } catch (err) {
      console.error("Errore loadAndamento:", err);
    }
  }

  function renderGrafico(labels, giornaliero, investito) {
    if (grafico) grafico.destroy();

    grafico = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Giornaliero",
            data: giornaliero,
            borderColor: "rgba(0, 180, 255, 0.95)",
            backgroundColor: "rgba(0, 180, 255, 0.18)",
            pointRadius: 3,
            pointHoverRadius: 6,
            borderWidth: 3,
            tension: 0.35,
            fill: true,
          },
          {
            label: "Investito",
            data: investito,
            borderColor: "rgba(255, 220, 0, 0.95)",
            backgroundColor: "rgba(255, 220, 0, 0.14)",
            pointRadius: 3,
            pointHoverRadius: 6,
            borderWidth: 3,
            tension: 0.35,
            fill: true,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: "#ffffff", font: { size: 13 } }
          },
          tooltip: {
            backgroundColor: "rgba(0,0,0,0.75)",
            titleColor: "#fff",
            bodyColor: "#fff",
            padding: 10,
            displayColors: false,
            callbacks: {
              // mostra label con valore e dataset name
              label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y} â‚¬`
            }
          }
        },
        scales: {
          x: {
            ticks: { color: "#ddd", maxRotation: 45, minRotation: 45 },
            grid: { color: "rgba(255,255,255,0.03)" },
            title: { display: true, text: "Data (gg/mm)", color: "#ccc" }
          },
          y: {
            ticks: { color: "#ddd" },
            grid: { color: "rgba(255,255,255,0.05)" },
            title: { display: true, text: "Valore (â‚¬)", color: "#ccc" }
          }
        }
      }
    });
  }

  // avvia
  loadAndamento();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Andamento Portafoglio</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* =========================================================
       COLORI AUTOMATICI PER LIGHT E DARK THEME
       ========================================================= */
    :root {
      --bg: #ffffff;
      --text: #222;
      --card-bg: rgba(0,0,0,0.05);
      --table-bg: rgba(0,0,0,0.04);
      --border: rgba(0,0,0,0.15);
      --th-bg: rgba(0,0,0,0.1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0e0e0e;
        --text: #f0f0f0;
        --card-bg: rgba(255,255,255,0.04);
        --table-bg: rgba(255,255,255,0.03);
        --border: rgba(255,255,255,0.05);
        --th-bg: rgba(255,255,255,0.07);
      }
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h1 { text-align:center; margin-bottom:12px; }

    #grafico-container {
      background: var(--card-bg);
      padding:18px;
      border-radius:12px;
      box-shadow:0 8px 25px rgba(0,0,0,0.4);
    }
    #grafico { width:100% !important; height:360px !important; display:block; }

    /* ----- TABELLA MENSILE ---- */
    .mensile-wrap {
      margin-top:18px;
      background: var(--card-bg);
      padding:14px;
      border-radius:10px;
    }

    #tabella-mensile {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size:14px;
      background: var(--table-bg);
      color: var(--text);
    }

    #tabella-mensile col:nth-child(1){width:18%}
    #tabella-mensile col:nth-child(2){width:14%}
    #tabella-mensile col:nth-child(3){width:14%}
    #tabella-mensile col:nth-child(4){width:14%}
    #tabella-mensile col:nth-child(5){width:14%}
    #tabella-mensile col:nth-child(6){width:12%}
    #tabella-mensile col:nth-child(7){width:14%}

    thead th {
      padding:10px;
      background: var(--th-bg);
      font-weight:700;
      white-space: nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    tbody td {
      padding:10px;
      border-top:1px solid var(--border);
      white-space: nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* allineamento */
    td:nth-child(1), th:nth-child(1){text-align:left}
    td:nth-child(2), th:nth-child(2){text-align:right}
    td:nth-child(3), th:nth-child(3){text-align:right}
    td:nth-child(4), th:nth-child(4){text-align:right}
    td:nth-child(5), th:nth-child(5){text-align:right}
    td:nth-child(6), th:nth-child(6){text-align:right}
    td:nth-child(7), th:nth-child(7){text-align:center}

    /* verde / rosso */
    .positivo { color:#4caf50 !important; font-weight:bold; }
    .negativo { color:#ff5252 !important; font-weight:bold; }

    /* dettagli */
    .details-row td { background: var(--table-bg); padding:0; }
    .details-inner { padding:10px 12px; }
    .detail-table { width:100%; border-collapse:collapse; table-layout:fixed; font-size:13px; }

    .detail-table th {
      background: var(--th-bg);
      padding:8px;
      text-align:left;
    }

    .detail-table td {
      padding:8px;
      border-top:1px solid var(--border);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .btn-toggle, .btn-edit, .btn-save, .btn-cancel {
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
      padding:6px 8px;
      border-radius:8px;
      cursor:pointer;
    }
  </style>
</head>
<body>

<h1>üìà Andamento Portafoglio</h1>

<div id="grafico-container">
  <canvas id="grafico"></canvas>
</div>

<div class="mensile-wrap">
  <h2>üìä Riepilogo Mensile</h2>

  <table id="tabella-mensile">
    <colgroup>
      <col><col><col><col><col><col><col>
    </colgroup>

    <thead>
      <tr>
        <th>Data (ultimo mese)</th>
        <th>Investito</th>
        <th>Valore</th>
        <th>Incremento</th>
        <th>Profitto</th>
        <th>% Profitto</th>
        <th>Dettagli</th>
      </tr>
    </thead>

    <tbody></tbody>
  </table>
</div>

<!-- ===========================
       JAVASCRIPT PRINCIPALE
     =========================== -->
<script type="module">
  import { db } from "./firebase-config.js";
  import { collection, getDocs, doc, updateDoc }
    from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  const ctx = document.getElementById("grafico").getContext("2d");
  let grafico = null;

  const formatDate = id => {
    const [y,m,d] = id.split("-");
    return `${d}/${m}/${y}`;
  };

  async function loadAndamento() {
    const snap = await getDocs(collection(db, "andamento"));
    const raw = [];
    snap.forEach(x => raw.push({ id:x.id, ...x.data() }));
    raw.sort((a,b) => new Date(a.id) - new Date(b.id));

    const labels = raw.map(r => formatDate(r.id).slice(0,5));
    const gior = raw.map(r => Number(r.GIORNALIERO || 0));
    const inv  = raw.map(r => Number(r.INVESTITO || 0));

    if (grafico) grafico.destroy();
    grafico = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          { label:"Giornaliero", data:gior, borderColor:"cyan", tension:0.3 },
          { label:"Investito", data:inv, borderColor:"yellow", tension:0.3 }
        ]
      },
      options: { responsive:true }
    });

    const perMese = {};
    raw.forEach(r => {
      const k = r.id.slice(0,7);
      perMese[k] = r;
    });

    renderTabella(perMese, raw);
  }

  function renderTabella(perMese, raw) {
    const tbody = document.querySelector("#tabella-mensile tbody");
    tbody.innerHTML = "";

    let lastInv = null;

    Object.keys(perMese).sort().forEach(mese => {
      const r = perMese[mese];
      const inv = Number(r.INVESTITO);
      const val = Number(r.GIORNALIERO);
      const incremento = lastInv != null ? inv - lastInv : 0;
      const profitto = val - inv;
      const perc = inv > 0 ? ((profitto / inv) * 100).toFixed(2) : 0;
      lastInv = inv;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatDate(r.id)}</td>
        <td class="right">${inv} ‚Ç¨</td>
        <td class="right">${val} ‚Ç¨</td>
        <td class="right ${incremento>=0?'positivo':'negativo'}">${incremento} ‚Ç¨</td>
        <td class="right ${profitto>=0?'positivo':'negativo'}">${profitto} ‚Ç¨</td>
        <td class="right ${profitto>=0?'positivo':'negativo'}">${perc}%</td>
        <td class="center"><button class="btn-toggle" data-mese="${mese}">Dettagli ‚ñ∏</button></td>
      `;
      tbody.appendChild(tr);

      const detRow = document.createElement("tr");
      detRow.className = "details-row";
      detRow.style.display = "none";
      detRow.dataset.mese = mese;
      detRow.innerHTML = `<td colspan="7" class="details-inner"></td>`;
      tbody.appendChild(detRow);
    });

    tbody.addEventListener("click", async e => {
      const btn = e.target.closest(".btn-toggle");
      if (!btn) return;
      const mese = btn.dataset.mese;

      const detRow = tbody.querySelector(`tr.details-row[data-mese="${mese}"]`);
      const box = detRow.querySelector(".details-inner");

      if (detRow.style.display === "table-row") {
        detRow.style.display = "none";
        btn.textContent = "Dettagli ‚ñ∏";
        return;
      }

      const records = raw.filter(r => r.id.startsWith(mese));
      records.sort((a,b) => new Date(a.id) - new Date(b.id));

      box.innerHTML = `
        <table class="detail-table">
          <colgroup><col><col><col><col><col><col></colgroup>
          <thead>
            <tr>
              <th>Data</th>
              <th>Investito</th>
              <th>Valore</th>
              <th>Profitto</th>
              <th>%</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            ${records.map(r => {
              const inv = Number(r.INVESTITO);
              const val = Number(r.GIORNALIERO);
              const pf = val - inv;
              const pc = inv>0 ? ((pf/inv)*100).toFixed(2) : 0;

              return `
              <tr>
                <td>${formatDate(r.id)}</td>
                <td class="right">${inv} ‚Ç¨</td>
                <td class="right">${val} ‚Ç¨</td>
                <td class="right ${pf>=0?'positivo':'negativo'}">${pf} ‚Ç¨</td>
                <td class="right ${pf>=0?'positivo':'negativo'}">${pc}%</td>
                <td class="center"><button class="btn-edit" data-id="${r.id}">‚úèÔ∏è</button></td>
              </tr>`;
            }).join("")}
          </tbody>
        </table>
      `;

      detRow.style.display = "table-row";
      btn.textContent = "Chiudi ‚ñæ";
    });
  }

  loadAndamento();
</script>

</body>
</html>

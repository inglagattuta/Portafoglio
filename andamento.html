<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Andamento Portafoglio</title>

  <link rel="stylesheet" href="style.css?v=5">
  <link rel="stylesheet" href="andamento.css?v=2">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<script>
  const savedTheme = localStorage.getItem("theme") || "light";
  document.body.dataset.theme = savedTheme;
  if (savedTheme === "dark") document.body.classList.add("dark");
</script>

<div class="container">
  <header>
    <h1>ğŸ“ˆ Andamento Portafoglio</h1>
    <p class="subtitle">Francesco La Gattuta</p>
  </header>

  <div class="controls">
    <button onclick="location.href='index.html'">ğŸ  Home</button>
    <button onclick="location.href='dashboard.html'">ğŸ“Š Dashboard</button>
    <button onclick="location.href='dividendi.html'">ğŸ’° Dividendi</button>
    <button onclick="location.href='calendario.html'">ğŸ“… Calendario</button>
  </div>

  <div class="summary-boxes">
    <div class="box" id="box-investito"><div class="label">Investito</div><div class="value">0 â‚¬</div></div>
    <div class="box" id="box-valore"><div class="label">Valore</div><div class="value">0 â‚¬</div></div>
    <div class="box" id="box-profitto"><div class="label">Profitto</div><div class="value">0 â‚¬</div></div>
    <div class="box" id="box-percentuale"><div class="label">% Profitto</div><div class="value">0%</div></div>
  </div>

  <div id="grafico-container">
    <canvas id="grafico"></canvas>
  </div>

  <h2>ğŸ“Š Riepilogo Mensile</h2>
  <div class="table-container">
    <table id="tabella-mensile">
      <thead>
        <tr>
          <th>Data</th>
          <th>Investito</th>
          <th>Valore</th>
          <th>Incremento</th>
          <th>Profitto</th>
          <th>%</th>
          <th>Dettagli</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import {
  collection,
  getDocs,
  doc,
  updateDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

const ctx = document.getElementById("grafico");
let grafico = null;

const fmt = id => {
  const p = id.split("-");
  return `${p[2]}/${p[1]}/${p[0]}`;
};

async function loadAndamento() {
  const snap = await getDocs(collection(db, "andamento"));
  const raw = [];
  snap.forEach(d => raw.push({ id: d.id, ...d.data() }));
  raw.sort((a,b) => new Date(a.id) - new Date(b.id));

  updateBoxes(raw);
  drawChart(raw);
  renderTable(raw);
}

function updateBoxes(raw) {
  if (!raw.length) return;
  const last = raw.at(-1);
  const inv = last.INVESTITO || 0;
  const val = last.GIORNALIERO || 0;
  const pf = val - inv;
  const pct = inv > 0 ? (pf/inv*100).toFixed(2) : "0.00";

  box("box-investito", inv);
  box("box-valore", val);
  box("box-profitto", pf);
  document.querySelector("#box-percentuale .value").textContent = pct + "%";
}

function box(id,val){
  document.querySelector(`#${id} .value`).textContent = val.toFixed(2)+" â‚¬";
}

function drawChart(raw){
  if (grafico) grafico.destroy();
  grafico = new Chart(ctx, {
    type:"line",
    data:{
      labels: raw.map(r=>fmt(r.id)),
      datasets:[
        {label:"Valore", data:raw.map(r=>r.GIORNALIERO), borderWidth:2},
        {label:"Investito", data:raw.map(r=>r.INVESTITO), borderWidth:2}
      ]
    }
  });
}

function renderTable(raw){
  const tbody = document.querySelector("#tabella-mensile tbody");
  tbody.innerHTML = "";
  let lastInv = null;

  raw.forEach(r=>{
    const pf = r.GIORNALIERO - r.INVESTITO;
    const inc = lastInv!==null ? r.INVESTITO-lastInv : 0;
    lastInv = r.INVESTITO;

    tbody.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${fmt(r.id)}</td>
        <td>${r.INVESTITO.toFixed(2)} â‚¬</td>
        <td>${r.GIORNALIERO.toFixed(2)} â‚¬</td>
        <td>${inc.toFixed(2)} â‚¬</td>
        <td>${pf.toFixed(2)} â‚¬</td>
        <td>${(pf/r.INVESTITO*100||0).toFixed(2)}%</td>
        <td>
         <button class="icon-btn edit" title="Modifica" data-id="...">
  âœï¸
</button>
<button class="icon-btn delete" title="Elimina" data-id="...">
  ğŸ—‘ï¸
</button>

        </td>
      </tr>
    `);
  });
}

document.querySelector("#tabella-mensile tbody")
.addEventListener("click", async e => {

  const del = e.target.closest(".btn-delete");
  if (del) {
    if (!confirm("Eliminare questo record?")) return;
    await deleteDoc(doc(db,"andamento",del.dataset.id));
    await loadAndamento();
    return;
  }

  const edit = e.target.closest(".btn-edit");
  if (edit) {
    const tr = edit.closest("tr");
    const inv = parseFloat(tr.children[1].textContent);
    const val = parseFloat(tr.children[2].textContent);
    tr.children[1].innerHTML = `<input value="${inv}">`;
    tr.children[2].innerHTML = `<input value="${val}">`;
    tr.children[6].innerHTML = `
      <button class="btn-save" data-id="${edit.dataset.id}">ğŸ’¾</button>
      <button class="btn-cancel">âœ–</button>`;
    return;
  }

  const save = e.target.closest(".btn-save");
  if (save) {
    const tr = save.closest("tr");
    await updateDoc(doc(db,"andamento",save.dataset.id),{
      INVESTITO:Number(tr.children[1].querySelector("input").value),
      GIORNALIERO:Number(tr.children[2].querySelector("input").value)
    });
    await loadAndamento();
    return;
  }

  if (e.target.closest(".btn-cancel")) {
    await loadAndamento();
  }
});

loadAndamento();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Andamento Portafoglio</title>

  <!-- usa lo stesso CSS della dashboard -->
  <link rel="stylesheet" href="style.css?v=5">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* piccole integrazioni locali che non sovrascrivono il tema */
    #grafico-container { padding:12px; border-radius:10px; margin-bottom:12px; }
    #grafico { width:100% !important; height:360px !important; display:block; }

    /* assicurati che la tabella mensile sia leggibile con il tema */
    .mensile-wrap { padding:12px; border-radius:10px; }
    #tabella-mensile { width:100%; border-collapse:collapse; table-layout:fixed; font-size:14px; }
    #tabella-mensile col:nth-child(1){width:18%}
    #tabella-mensile col:nth-child(2){width:14%}
    #tabella-mensile col:nth-child(3){width:14%}
    #tabella-mensile col:nth-child(4){width:14%}
    #tabella-mensile col:nth-child(5){width:14%}
    #tabella-mensile col:nth-child(6){width:12%}
    #tabella-mensile col:nth-child(7){width:14%}

    thead th { padding:10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    tbody td { padding:10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; border-top: 1px solid rgba(0,0,0,0.06); }

    td:nth-child(1), th:nth-child(1) { text-align:left; }
    td:nth-child(2), th:nth-child(2),
    td:nth-child(3), th:nth-child(3),
    td:nth-child(4), th:nth-child(4),
    td:nth-child(5), th:nth-child(5),
    td:nth-child(6), th:nth-child(6) { text-align:right; }
    td:nth-child(7), th:nth-child(7) { text-align:center; }

    .positivo { color:#4caf50 !important; font-weight:700; }
    .negativo { color:#ff5252 !important; font-weight:700; }

    .btn-toggle, .btn-edit, .btn-save, .btn-cancel {
      background:transparent; border:1px solid rgba(0,0,0,0.08); padding:6px 8px; border-radius:8px; cursor:pointer;
    }

    /* controls (nav) */
    .controls { display:flex; gap:12px; margin-bottom:14px; flex-wrap:wrap; }
    .controls button, .controls a { padding:10px 16px; border-radius:10px; border:none; cursor:pointer; text-decoration:none; color:inherit; }
  </style>
</head>
<body>
  <!-- applica il tema prima di renderizzare il resto (come nel dashboard) -->
  <script>
    const savedTheme = localStorage.getItem("theme") || "light";
    document.body.dataset.theme = savedTheme;
    if (savedTheme === "dark") document.body.classList.add("dark");
    else document.body.classList.remove("dark");
  </script>

  <div class="container">
    <header>
      <h1>üìà Andamento Portafoglio</h1>
      <p class="subtitle">Francesco La Gattuta</p>
    </header>

    <div class="controls">
      <button onclick="window.location.href='index.html'">üè† Home</button>
      <button onclick="window.location.href='dividendi.html'">üí∞ Dividendi</button>
      <a class="dashboard-btn" href="dashboard.html" style="background:#0984e3; color:#fff; padding:10px 14px; border-radius:10px; align-self:center;">üìä Dashboard</a>
    </div>

    <div id="grafico-container">
      <canvas id="grafico"></canvas>
    </div>

    <div class="mensile-wrap" aria-live="polite">
      <h2 style="margin:6px 0 10px;">üìä Riepilogo Mensile</h2>

      <!-- colgroup per forzare larghezze e garantire allineamento -->
      <table id="tabella-mensile" aria-describedby="riepilogo-mensile">
        <colgroup>
          <col> <!-- Data -->
          <col> <!-- Investito -->
          <col> <!-- Valore -->
          <col> <!-- Incremento -->
          <col> <!-- Profitto -->
          <col> <!-- % Profitto -->
          <col> <!-- Dettagli -->
        </colgroup>
        <thead>
          <tr>
            <th>Data (ultimo mese)</th>
            <th>Investito</th>
            <th>Valore</th>
            <th>Incremento</th>
            <th>Profitto</th>
            <th>% Profitto</th>
            <th>Dettagli</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script type="module">
  import { db } from "./firebase-config.js";
  import { collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  const ctx = document.getElementById("grafico").getContext("2d");
  let grafico = null;

  const formatFull = id => {
    const p = String(id).split("-");
    if (p.length >= 3) return `${p[2].padStart(2,'0')}/${p[1].padStart(2,'0')}/${p[0]}`;
    return id;
  };
  const formatShort = id => {
    const p = String(id).split("-");
    if (p.length >= 3) return `${p[2].padStart(2,'0')}/${p[1].padStart(2,'0')}`;
    return id;
  };

  async function loadAndamento() {
    try {
      const snap = await getDocs(collection(db, "andamento"));
      const raw = [];
      snap.forEach(d => raw.push({ id: d.id, ...d.data() }));
      if (!raw.length) {
        document.querySelector("#tabella-mensile tbody").innerHTML = "<tr><td colspan='7' class='center'>Nessun dato</td></tr>";
        return;
      }

      raw.sort((a,b) => new Date(a.id) - new Date(b.id));

      // grafico
      const labels = raw.map(r => formatShort(r.id));
      const giornaliero = raw.map(r => Number(r.GIORNALIERO || 0));
      const investito = raw.map(r => Number(r.INVESTITO || 0));

      if (grafico) grafico.destroy();
      grafico = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[
          { label:'Giornaliero', data:giornaliero, borderColor:'rgba(0,180,255,1)', backgroundColor:'rgba(0,180,255,0.12)', tension:0.3, fill:true },
          { label:'Investito', data:investito, borderColor:'rgba(255,220,0,1)', backgroundColor:'rgba(255,220,0,0.08)', tension:0.3, fill:true }
        ]},
        options:{
          responsive:true,
          plugins: { legend: { labels: { color: getComputedStyle(document.body).color } } },
          scales: { x: { ticks: { color: getComputedStyle(document.body).color } }, y: { ticks: { color: getComputedStyle(document.body).color } } }
        }
      });

      // perMese: ultimo record per mese (YYYY-MM)
      const perMese = {};
      raw.forEach(r => {
        const key = r.id.slice(0,7);
        perMese[key] = r;
      });

      renderTabella(perMese, raw);
    } catch (err) {
      console.error("Errore loadAndamento:", err);
      alert("Errore caricamento dati (vedi console).");
    }
  }

  function renderTabella(perMese, rawRecords) {
    // rimuovo eventuali listener clonando il tbody
    const old = document.querySelector("#tabella-mensile tbody");
    const tbody = old.cloneNode(false);
    old.parentNode.replaceChild(tbody, old);

    let lastInv = null;
    Object.keys(perMese).sort().forEach(mese => {
      const r = perMese[mese];
      const inv = Number(r.INVESTITO || 0);
      const val = Number(r.GIORNALIERO || 0);
      const incremento = lastInv !== null ? inv - lastInv : 0;
      lastInv = inv;
      const profitto = val - inv;
      const perc = inv > 0 ? ((profitto / inv) * 100).toFixed(2) : "0.00";

      const tr = document.createElement("tr");
      tr.dataset.mese = mese;
      tr.innerHTML = `
        <td>${formatFull(r.id)}</td>
        <td class="right">${inv} ‚Ç¨</td>
        <td class="right">${val} ‚Ç¨</td>
        <td class="${incremento>=0?'positivo':'negativo'} right">${incremento} ‚Ç¨</td>
        <td class="${profitto>=0?'positivo':'negativo'} right">${profitto} ‚Ç¨</td>
        <td class="${profitto>=0?'positivo':'negativo'} right">${perc}%</td>
        <td class="center"><button class="btn-toggle" data-mese="${mese}">Dettagli ‚ñ∏</button></td>
      `;
      tbody.appendChild(tr);

      // riga dei dettagli (nascosta)
      const detRow = document.createElement("tr");
      detRow.className = "details-row";
      detRow.style.display = "none";
      detRow.dataset.mese = mese;
      const td = document.createElement("td");
      td.colSpan = 7;
      td.className = "details-inner";
      td.innerHTML = `<div class="details-inner"><em>Carica dettagli...</em></div>`;
      detRow.appendChild(td);
      tbody.appendChild(detRow);
    });

    // delegazione eventi sul tbody nuovo
    tbody.addEventListener("click", async (e) => {
      const toggle = e.target.closest(".btn-toggle");
      if (toggle) {
        const mese = toggle.dataset.mese;
        const detRow = tbody.querySelector(`tr.details-row[data-mese="${mese}"]`);
        const container = detRow.querySelector(".details-inner");
        if (detRow.style.display === "table-row") {
          detRow.style.display = "none";
          toggle.textContent = "Dettagli ‚ñ∏";
          return;
        }
        // filtra giornate del mese
        const records = rawRecords.filter(rr => rr.id.startsWith(mese)).sort((a,b) => new Date(a.id)-new Date(b.id));
        container.innerHTML = `
          <table class="detail-table">
            <colgroup><col><col><col><col><col><col></colgroup>
            <thead><tr><th>Data</th><th>Investito</th><th>Valore</th><th>Profitto</th><th>%</th><th>Azioni</th></tr></thead>
            <tbody>
              ${records.map(r => {
                const inv = Number(r.INVESTITO || 0);
                const val = Number(r.GIORNALIERO || 0);
                const pf = val - inv;
                const pct = inv>0?((pf/inv)*100).toFixed(2):"0.00";
                return `<tr data-docid="${r.id}">
                  <td>${formatFull(r.id)}</td>
                  <td class="right">${inv} ‚Ç¨</td>
                  <td class="right">${val} ‚Ç¨</td>
                  <td class="right ${pf>=0?'positivo':'negativo'}">${pf} ‚Ç¨</td>
                  <td class="right ${pf>=0?'positivo':'negativo'}">${pct}%</td>
                  <td class="center"><button class="btn-edit" data-docid="${r.id}">‚úèÔ∏è Modifica</button></td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        `;
        detRow.style.display = "table-row";
        toggle.textContent = "Chiudi ‚ñæ";
        return;
      }

      // Edit -> trasforma in input
      const editBtn = e.target.closest(".btn-edit");
      if (editBtn) {
        const tr = editBtn.closest("tr");
        const tds = tr.querySelectorAll("td");
        const curInv = tds[1].textContent.replace(' ‚Ç¨','').trim();
        const curVal = tds[2].textContent.replace(' ‚Ç¨','').trim();
        tds[1].innerHTML = `<input class="input-invest" type="number" step="0.01" value="${Number(curInv)}" style="width:110px">`;
        tds[2].innerHTML = `<input class="input-val" type="number" step="0.01" value="${Number(curVal)}" style="width:110px">`;
        tds[3].textContent = '-';
        tds[4].textContent = '-';
        tds[5].innerHTML = `<button class="btn-save" data-docid="${editBtn.dataset.docid}">üíæ Salva</button> <button class="btn-cancel" data-docid="${editBtn.dataset.docid}">‚ùå Annulla</button>`;
        tr.classList.add("editing");
        return;
      }

      // Cancel -> ricarica per ripristinare stato
      const cancel = e.target.closest(".btn-cancel");
      if (cancel) {
        await loadAndamento();
        return;
      }

      // Save -> aggiorna Firestore
      const save = e.target.closest(".btn-save");
      if (save) {
        const docid = save.dataset.docid;
        const tr = save.closest("tr");
        const newInv = Number(tr.querySelector(".input-invest").value || 0);
        const newVal = Number(tr.querySelector(".input-val").value || 0);
        save.disabled = true;
        const cancelBtn = tr.querySelector(".btn-cancel");
        if (cancelBtn) cancelBtn.disabled = true;
        try {
          const docRef = doc(db, "andamento", docid);
          await updateDoc(docRef, { INVESTITO: newInv, GIORNALIERO: newVal });
          await loadAndamento();
        } catch (err) {
          console.error("Errore updateDoc:", err);
          alert("Errore durante il salvataggio. Controlla console.");
        } finally {
          save.disabled = false;
          if (cancelBtn) cancelBtn.disabled = false;
        }
        return;
      }
    });
  }

  // inizio
  loadAndamento();
</script>
</body>
</html>

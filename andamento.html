<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Andamento Portafoglio</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0e0e0e; --text:#f0f0f0; --card-bg: rgba(255,255,255,0.03);
      --border: rgba(255,255,255,0.05); --th-bg: rgba(255,255,255,0.06);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#fff; --text:#222; --card-bg: rgba(0,0,0,0.03);
        --border: rgba(0,0,0,0.08); --th-bg: rgba(0,0,0,0.06);
      }
    }

    body{ background:var(--bg); color:var(--text); font-family:Arial, sans-serif; margin:20px; }
    h1{text-align:center;margin-bottom:12px;}
    #grafico-container{ background:var(--card-bg); padding:18px; border-radius:12px; }
    #grafico{ width:100% !important; height:360px !important; display:block; }

    .mensile-wrap{ margin-top:18px; background:var(--card-bg); padding:14px; border-radius:10px; }
    #tabella-mensile{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:14px; color:var(--text); background:transparent;}
    #tabella-mensile col:nth-child(1){width:18%}
    #tabella-mensile col:nth-child(2){width:14%}
    #tabella-mensile col:nth-child(3){width:14%}
    #tabella-mensile col:nth-child(4){width:14%}
    #tabella-mensile col:nth-child(5){width:14%}
    #tabella-mensile col:nth-child(6){width:12%}
    #tabella-mensile col:nth-child(7){width:14%}
    thead th{ padding:10px; background:var(--th-bg); font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    tbody td{ padding:10px; border-top:1px solid var(--border); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    td:nth-child(1), th:nth-child(1){text-align:left}
    td:nth-child(2), th:nth-child(2){text-align:right}
    td:nth-child(3), th:nth-child(3){text-align:right}
    td:nth-child(4), th:nth-child(4){text-align:right}
    td:nth-child(5), th:nth-child(5){text-align:right}
    td:nth-child(6), th:nth-child(6){text-align:right}
    td:nth-child(7), th:nth-child(7){text-align:center}
    .positivo{ color:#4caf50 !important; font-weight:700; }
    .negativo{ color:#ff5252 !important; font-weight:700; }

    .details-row td{ padding:0; background:transparent; }
    .details-inner{ padding:10px 12px; }
    .detail-table{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:13px; }
    .detail-table th{ padding:8px; text-align:left; background:var(--th-bg); }
    .detail-table td{ padding:8px; border-top:1px solid var(--border); }

    .btn-toggle, .btn-edit, .btn-save, .btn-cancel {
      background:transparent; border:1px solid var(--border); color:var(--text); padding:6px 8px; border-radius:8px; cursor:pointer;
    }

    .right { text-align:right; }
    .center { text-align:center; }

    @media (max-width:800px){
      .mensile-wrap{ overflow-x:auto; }
    }
  </style>
</head>
<body>

<h1>üìà Andamento Portafoglio</h1>

<div id="grafico-container">
  <canvas id="grafico"></canvas>
</div>

<div class="mensile-wrap" aria-live="polite">
  <h2 style="margin:10px 0 12px;">üìä Riepilogo Mensile</h2>

  <table id="tabella-mensile" aria-describedby="riepilogo-mensile">
    <colgroup>
      <col><col><col><col><col><col><col>
    </colgroup>
    <thead>
      <tr>
        <th>Data (ultimo mese)</th>
        <th>Investito</th>
        <th>Valore</th>
        <th>Incremento</th>
        <th>Profitto</th>
        <th>% Profitto</th>
        <th>Dettagli</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
  import { db } from "./firebase-config.js";
  import { collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  const ctx = document.getElementById("grafico").getContext("2d");
  let grafico = null;

  const formatFull = id => {
    const parts = String(id).split("-");
    if (parts.length >= 3) return `${parts[2].padStart(2,'0')}/${parts[1].padStart(2,'0')}/${parts[0]}`;
    return id;
  };
  const formatShort = id => {
    const parts = String(id).split("-");
    if (parts.length >= 3) return `${parts[2].padStart(2,'0')}/${parts[1].padStart(2,'0')}`;
    return id;
  };

  async function loadAndamento() {
    try {
      const snap = await getDocs(collection(db, "andamento"));
      const raw = [];
      snap.forEach(d => raw.push({ id: d.id, ...d.data() }));
      raw.sort((a,b) => new Date(a.id) - new Date(b.id));

      // render grafico
      const labels = raw.map(r => formatShort(r.id));
      const giornaliero = raw.map(r => Number(r.GIORNALIERO || 0));
      const investito = raw.map(r => Number(r.INVESTITO || 0));

      if (grafico) grafico.destroy();
      grafico = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[
          { label:'Giornaliero', data:giornaliero, borderColor:'rgba(0,180,255,1)', backgroundColor:'rgba(0,180,255,0.12)', tension:0.3, fill:true },
          { label:'Investito', data:investito, borderColor:'rgba(255,220,0,1)', backgroundColor:'rgba(255,220,0,0.08)', tension:0.3, fill:true }
        ]},
        options:{ responsive:true, maintainAspectRatio:false }
      });

      // calcolo ultimo giorno per mese
      const perMese = {};
      raw.forEach(r => {
        const key = r.id.slice(0,7); // YYYY-MM
        perMese[key] = r; // overwrite -> last day remains
      });

      renderTabella(perMese, raw);
    } catch (err) {
      console.error("Errore loadAndamento:", err);
      alert("Errore caricamento dati (vedi console)");
    }
  }

  function renderTabella(perMese, rawRecords) {
    // clono tbody per rimuovere eventuali listener precedenti
    const oldTbody = document.querySelector("#tabella-mensile tbody");
    const newTbody = oldTbody.cloneNode(false); // vuoto ma senza listener
    oldTbody.parentNode.replaceChild(newTbody, oldTbody);

    let lastInv = null;
    Object.keys(perMese).sort().forEach(mese => {
      const r = perMese[mese];
      const inv = Number(r.INVESTITO || 0);
      const val = Number(r.GIORNALIERO || 0);
      const incremento = lastInv !== null ? inv - lastInv : 0;
      lastInv = inv;
      const profitto = val - inv;
      const perc = inv > 0 ? ((profitto / inv) * 100).toFixed(2) : "0.00";

      const tr = document.createElement("tr");
      tr.dataset.mese = mese;
      tr.innerHTML = `
        <td>${formatFull(r.id)}</td>
        <td class="right">${inv} ‚Ç¨</td>
        <td class="right">${val} ‚Ç¨</td>
        <td class="right ${incremento>=0?'positivo':'negativo'}">${incremento} ‚Ç¨</td>
        <td class="right ${profitto>=0?'positivo':'negativo'}">${profitto} ‚Ç¨</td>
        <td class="right ${profitto>=0?'positivo':'negativo'}">${perc}%</td>
        <td class="center"><button class="btn-toggle" data-mese="${mese}">Dettagli ‚ñ∏</button></td>
      `;
      newTbody.appendChild(tr);

      // dettaglio row (nascondi)
      const detRow = document.createElement("tr");
      detRow.className = "details-row";
      detRow.style.display = "none";
      detRow.dataset.mese = mese;
      const td = document.createElement("td");
      td.colSpan = 7;
      td.className = "details-inner";
      td.innerHTML = `<div class="details-inner"><em>Carica dettagli...</em></div>`;
      detRow.appendChild(td);
      newTbody.appendChild(detRow);
    });

    // delegazione eventi sul nuovo tbody
    newTbody.addEventListener("click", async (e) => {
      const toggle = e.target.closest(".btn-toggle");
      if (toggle) {
        const mese = toggle.dataset.mese;
        const detRow = newTbody.querySelector(`tr.details-row[data-mese="${mese}"]`);
        const container = detRow.querySelector(".details-inner");

        if (detRow.style.display === "table-row") {
          detRow.style.display = "none";
          toggle.textContent = "Dettagli ‚ñ∏";
          return;
        }

        // build dettagli per il mese
        const records = rawRecords
          .filter(rr => rr.id.startsWith(mese))
          .sort((a,b) => new Date(a.id) - new Date(b.id));

        container.innerHTML = `
          <table class="detail-table">
            <colgroup><col><col><col><col><col><col></colgroup>
            <thead>
              <tr>
                <th>Data</th><th>Investito</th><th>Valore</th><th>Profitto</th><th>%</th><th>Azioni</th>
              </tr>
            </thead>
            <tbody>
              ${records.map(r => {
                const inv = Number(r.INVESTITO || 0);
                const val = Number(r.GIORNALIERO || 0);
                const pf = val - inv;
                const pct = inv>0?((pf/inv)*100).toFixed(2):"0.00";
                return `<tr data-docid="${r.id}">
                  <td>${formatFull(r.id)}</td>
                  <td class="right">${inv} ‚Ç¨</td>
                  <td class="right">${val} ‚Ç¨</td>
                  <td class="right ${pf>=0?'positivo':'negativo'}">${pf} ‚Ç¨</td>
                  <td class="right ${pf>=0?'positivo':'negativo'}">${pct}%</td>
                  <td class="center">
                    <button class="btn-edit" data-docid="${r.id}">‚úèÔ∏è Modifica</button>
                  </td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        `;
        detRow.style.display = "table-row";
        toggle.textContent = "Chiudi ‚ñæ";
        return;
      }

      // edit row -> trasformo celle in input
      const editBtn = e.target.closest(".btn-edit");
      if (editBtn) {
        const tr = editBtn.closest("tr");
        const docid = editBtn.dataset.docid;
        const tds = tr.querySelectorAll("td");
        const curInvest = tds[1].textContent.replace(' ‚Ç¨','').trim();
        const curVal = tds[2].textContent.replace(' ‚Ç¨','').trim();

        tds[1].innerHTML = `<input class="input-invest" type="number" step="0.01" value="${Number(curInvest)}" style="width:110px">`;
        tds[2].innerHTML = `<input class="input-val" type="number" step="0.01" value="${Number(curVal)}" style="width:110px">`;
        tds[3].textContent = '-';
        tds[4].textContent = '-';
        tds[5].innerHTML = `
          <button class="btn-save" data-docid="${docid}">üíæ Salva</button>
          <button class="btn-cancel" data-docid="${docid}">‚ùå Annulla</button>
        `;
        tr.classList.add("editing");
        return;
      }

      // cancel -> ricarico i dati per ripristinare
      const cancelBtn = e.target.closest(".btn-cancel");
      if (cancelBtn) {
        await loadAndamento();
        return;
      }

      // save -> aggiorno firestore
      const saveBtn = e.target.closest(".btn-save");
      if (saveBtn) {
        const docid = saveBtn.dataset.docid;
        const tr = saveBtn.closest("tr");
        const inpInv = tr.querySelector(".input-invest");
        const inpVal = tr.querySelector(".input-val");
        const newInv = Number(inpInv.value || 0);
        const newVal = Number(inpVal.value || 0);

        saveBtn.disabled = true;
        const cancel = tr.querySelector(".btn-cancel");
        if (cancel) cancel.disabled = true;

        try {
          const docRef = doc(db, "andamento", docid);
          await updateDoc(docRef, { INVESTITO: newInv, GIORNALIERO: newVal });
          await loadAndamento();
        } catch (err) {
          console.error("Errore updateDoc:", err);
          alert("Errore durante il salvataggio (vedi console).");
        } finally {
          saveBtn.disabled = false;
          if (cancel) cancel.disabled = false;
        }
        return;
      }
    });
  }

  // avvia
  loadAndamento();
</script>

</body>
</html>

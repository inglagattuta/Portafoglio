<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendario Dividendi</title>

  <!-- Stile generale -->
  <link rel="stylesheet" href="style.css?v=4">
</head>

<body>
<script>
  // ğŸ”¥ sistema tema come in tutte le altre pagine
  const savedTheme = localStorage.getItem("theme") || "light";
  document.body.dataset.theme = savedTheme;
  if (savedTheme === "dark") document.body.classList.add("dark");
  else document.body.classList.remove("dark");
</script>

<div class="container">

  <header>
    <h1>ğŸ“… Calendario Dividendi</h1>
    <p class="subtitle">Prossime date di pagamento</p>
  </header>

  <!-- NAVIGATION BUTTONS â€” identici alle altre pagine -->
  <div class="controls">
    <button onclick="window.location.href='index.html'">ğŸ  Home</button>
    <button onclick="window.location.href='dividendi.html'">ğŸ’° Dividendi</button>
    <button onclick="window.location.href='dashboard.html'">ğŸ“Š Dashboard</button>
    <button onclick="window.location.href='andamento.html'">ğŸ“ˆ Andamento</button>
    <a class="dashboard-btn" href="calendario.html" style="background:#6c5ce7;">
      ğŸ“… Calendario
    </a>
  </div>

  <!-- STATISTICHE -->
  <section id="stats" class="cards-grid-3"></section>

  <!-- PROSSIMI 30 GIORNI -->
  <section style="margin-top:25px;">
    <h2>Prossimi 30 giorni</h2>
    <div id="next30" class="cards-list"></div>
  </section>

  <!-- TABELLA COMPLETA -->
  <section style="margin-top:35px;">
    <h2>Tutti i pagamenti</h2>

    <table class="styled-table">
      <thead>
        <tr>
          <th>Ticker</th>
          <th>Data</th>
          <th>Frequenza</th>
          <th>Yield</th>
          <th>Yield Annuale</th>
        </tr>
      </thead>
      <tbody id="allPayments"></tbody>
    </table>
  </section>

</div>

<!-- SCRIPT FIREBASE -->
<script type="module">
  import { db } from "./firebase-config.js";
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  async function load() {
    const snap = await getDocs(collection(db, "dividendi_annual"));
    const items = [];

    snap.forEach(doc => {
      const d = doc.data();
      if (!d.date_pagamento) return;

      d.date_pagamento.forEach(date => {
        items.push({
          ticker: d.ticker,
          prezzo: d.prezzo_acquisto,
          ultimo: d.ultimo_dividendo,
          date,
          freq: d.date_pagamento.length
        });
      });
    });

    items.sort((a,b)=> new Date(a.date) - new Date(b.date));

    renderStats(items);
    renderNext30(items);
    renderAll(items);
  }

  /* -----------------------
       STATISTICHE
  ------------------------ */
  function renderStats(items) {
    const total = items.reduce((acc, x)=> acc + (x.ultimo || 0), 0).toFixed(2);
    const freq = {};
    items.forEach(x => freq[x.ticker] = (freq[x.ticker] || 0) + 1);

    document.getElementById("stats").innerHTML = `
      <div class='mini-card'>
        <h3>Dividendi annuali</h3>
        <p>â‚¬ ${total}</p>
      </div>
      <div class='mini-card'>
        <h3>Titoli</h3>
        <p>${Object.keys(freq).length}</p>
      </div>
      <div class='mini-card'>
        <h3>Eventi totali</h3>
        <p>${items.length}</p>
      </div>
    `;
  }

  /* -----------------------
       PROSSIMI 30 GIORNI
  ------------------------ */
  function renderNext30(items) {
    const today = new Date();
    const future = new Date();
    future.setDate(today.getDate() + 30);

    const list = items.filter(x => {
      const d = new Date(x.date);
      return d >= today && d <= future;
    });

    document.getElementById("next30").innerHTML = list.map(x => {
      const yieldAnnual = (x.ultimo * x.freq / x.prezzo) * 100;

      return `
        <div class="card">
          <h3>${x.ticker}</h3>
          <p>${x.date}</p>
          <p class="profit">Yield Annuale: ${yieldAnnual.toFixed(2)}%</p>
        </div>
      `;
    }).join("");
  }

  /* -----------------------
       TABELLA COMPLETA
  ------------------------ */
  function renderAll(items) {
    document.getElementById("allPayments").innerHTML = items.map(x => {
      const yieldSingle = (x.ultimo / x.prezzo) * 100;
      const yieldAnnual = (x.ultimo * x.freq / x.prezzo) * 100;

      return `
        <tr>
          <td>${x.ticker}</td>
          <td>${x.date}</td>
          <td>${x.freq}x/anno</td>
          <td>${yieldSingle.toFixed(2)}%</td>
          <td class="profit">${yieldAnnual.toFixed(2)}%</td>
        </tr>
      `;
    }).join("");
  }

  load();
</script>

</body>
</html>
